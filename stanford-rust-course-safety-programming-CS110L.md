# STANFORD CS110L Rust Programming AND Safety Programming

译者注：我在知乎回答过一个有趣的问题：为什么大部分高校还在只教C/C++/Java，而不教更加强大的Rust/Go/Scala？当时我回答它的时候，其实在美国也不存在专门为教这些现代编程语言而专门开设的课程（有的只是一些使用现代语言写分布式、OS 等系统的课，重点并不在语言的教学上），所以我给出了一个答案。但是在斯坦福，情况可能发生了变化。

首先我想介绍下斯坦福的 CS Intro 课程体系

- 首先几乎所有斯坦福的理工科学生都要上 106A，这是一门使用 Python 的编程入门课。这种设计在中国也是一样的。
- CS 专业的同学要上 106B，这门课使用 C++，重点是抽象数据类型、数据结构、递归。学生会学到栈、堆、链表、二叉树、泛型编程的知识。有点像中国标准课程体系里的数据结构课。
- 106B 有一些替代/辅助课程，如内容更多速度更快的 106X，介绍现代 C++ 和 Qt 编程的 106L 等等。一个课号，多种选择，是美国计算机课程里很常见的事，最近很多中国大学也有这样的课程组了。
- 下一门课是 107，教学生在 UNIX 上编程，内容有寄存器、IO、汇编、内存模型、编译的过程、并发等。国内很多大学有一门讲 CSAPP 的课，与这门课内容是对应的。
- 最后一们导论课是 110，介绍的内容偏向操作系统和网络，如进程、存储和文件、网络、分布式。这有点像把 CSAPP 中更进阶的一些内容单独拿出来变成了一门课。
- 当然还有理论方面的 Intro 课程，在此不表。

下面要介绍的这门课课号是 110L，是 110 的辅助课程，名称是 Safety in Systems Programming，系统编程中的安全。主要内容是 Rust 编程。下面就看看这门课的老师是怎么看待 CS 本科专业里的 Rust 教学，以及这门课的意义的吧。

原文见 [https://reberhardt.com/blog/2020/10/05/designing-a-new-class-at-stanford-safety-in-systems-programming.html](https://reberhardt.com/blog/2020/10/05/designing-a-new-class-at-stanford-safety-in-systems-programming.html)，我省去了很多超链接和插图，翻译主要也是机器翻译，只修正了错译的专有名词，所以更推荐你去阅读原文。

如果能深入体验这门课，再好不过了。好消息就是这门课的视频就放在 Youtube 上，只是设置为不公开。提醒各位：注意保护知识产权，不要擅自做视频搬运。）

---

# 在斯坦福设计一个新的 Rust 课程：系统编程中的安全问题

Ryan Eberhardt

2020年10月5日

编写高质量的软件是很难的。有时，软件会以有趣的方式崩溃。然而，当软件作为从 Alexa 和 Google Home 这样的个人助理，到银行和选举的一切而运行时，一些错误可能会产生更严重的后果。

在过去的一个季度里，Armin Namavari 和我尝试着教了一门课：如何编写出不那么烂的软件。我们关注的是计算机系统中由某些愚蠢（但后果非常严重）的错误引起的常见问题，比如内存安全和线程安全问题。这门课的核心主题是，

- 现在系统编程的常见问题有哪些？
- 人们是如何应对这些问题的？
- 这些措施有哪些不足？

我们希望学生能够意识到这些困扰行业几十年的问题，我们希望教会学生如何使用人们开发的工具和心智模型来应对这些问题。然而，这些工具是不完善的，我们也希望学生能够体验和理解这种工具的局限性，以便更好地了解在构建系统时应该注意什么。

特别地，我们把重点放在了 Rust 编程语言的教学上，以此来建立更好的习惯，应对基于 C 和 C++ 的软件所特有的错误。在许多方面，Rust 需要良好的实践，它有一个教育性编译器，有帮助学生学习的错误信息。此外，我们还研究了如何应用 Rust 的经验教训在 C++ 中写出更好的代码，我们还向学生传授了一些工具，这些工具可用于在常见错误成为问题之前就检测到。

与典型的安全课不同的是，我们的目标是在课程中建立一个强大的软件工程方面的内容，给学生布置大量的代码作业，并试图改善学生的流程，而不仅仅是让学生认识到常见的问题。我们这门课的目标是训练学生成为更好的软件开发者，无论他们最终使用什么编程语言。

我认为这门课进行得相当顺利，学生的评价也非常积极。甚至在本季度结束前，学生们就告诉我们，这门课对其他课程的作业实现和调试非常有帮助。我们希望在今年秋天再次教授这门课，并希望能得到如何改进的意见。

这篇博文旨在总结我们所做的事情，为什么要这么做，以及我们对未来改变的想法。它很长，但写得很好，所以你可以跳到你感兴趣的地方。下面是一个大纲。

- 什么是安全，为什么我们要关心？
- 安全教育的想象
    - 是否应该有一个 "安全课程"？
    - 这与信安课程有什么不同？
    - 如何教授安全编程？
- 这门课的总结
    - 讲座
    - 作业
- 调查结果
- 经验教训
    - CS课程中是否有安全课的位置？
    - 学生在短时间内学习 Rust 是怎样的？
    - 我们是否应该尝试将 Rust 纳入斯坦福大学的核心课程中？
    - 这应该是一门独立的课，还是继续作为 CS 110 的附加课？
- 一般的教学经验

非常感谢 Armin Namavari，他是一个出色的合作讲师，感谢 Sergio Benitez 的精彩客座演讲，感谢 Will Crichton 在设计这门课时提供的反馈和指导，感谢 Jerry Cain 给我们提供的教学机会并在整个过程中给予鼓励，感谢 Rakesh Chatrath、Jeff Tucker、Vinesh Kannan、John Deng 和 Shiranka Miskin 对这篇文章的审稿。

## 什么是安全，我们为什么要关心？

不幸的是，安全是一个模糊术语，缺乏一个很好的定义。但就我们的目的而言，我们会说安全是避免【有害的】错误。我认为安全是关注潜在的严重 bug 的子集：如果一个网站上的按钮渲染成紫色而不是蓝色，那是一个我们可能不太在意的 bug，但如果银行账户软件允许用户多次提取相同的 1000 美元，或者如果自主车辆软件在某些情况下会出现故障，那就是一个更令人担忧的问题。

安全性在系统编程中尤为重要，因为系统编程很难。系统编程经常涉及到挑战硬件的极限，经常涉及到对多个线程的状态进行推理，有时甚至分布在数千台机器上。此外，出于性能和历史原因，大多数系统软件都是用 C 或 C++ 编写的，而 C 或 C++ 是出了名的难以正确使用。推理指针和内存是很难的，C 和 C++ 几乎对编程者没有什么帮助。C/C++ 薄弱的类型系统和定义不清的规范意味着它们会轻易接受明显有问题的代码。更糟糕的是，有无数的时候，这些语言糟糕的设计就是在求着错误发生。像 strcpy 这样简单的函数，将一个字符串从内存中的一个地方复制到另一个地方，极易被滥用，并且已经造成无数安全漏洞。strncpy 函数是为了解决 strcpy 的问题而推出的，然而 strncpy 原来几乎同样糟糕。即使是 printf，如果调用方式错误，也会导致安全漏洞。

另外，由于系统软件为其他软件的运行提供了基础，所以搞好系统软件尤为重要。许多现实世界的例子证明了上述问题的严重影响。我最喜欢的一个例子是在《Comprehensive Experimental Analyses of Automotive Attack Surfaces》中介绍的。这是一本很好的读物，总结来说，作者买了一辆流行的汽车，并试图找到尽可能多的方法，在没有物理访问的情况下远程劫持汽车。他们研究了无线钥匙扣、蓝牙，甚至胎压监测系统（利用无线信号传输轮胎中传感器的信息）等载体。每一个载体都被发现是可以利用的，其中许多是微不足道的。例如，蓝牙软件有 "超过20次对strcpy的调用，其中没有一次是明显安全的"。作者只看了 strcpy 的第一个实例，发现它在处理蓝牙配置命令时将数据复制到栈中，而不检查字符串的长度。这导致了一个潜在的缓冲区溢出问题，允许配对设备在媒体系统中执行任意代码。由于大多数汽车中的子系统缺乏隔离性，因此危及一个子系统(如媒体播放器)会导致整辆汽车的安全性丧失。2015年，研究人员就证明了这一点，远程劫持了一辆正在高速公路上行驶的吉普车。

这不仅仅是汽车行业的问题。许多行业的专业程序员经常会犯简单但严重的错误。

这似乎是我们应该讨论的问题。你会在没有对安全问题进行有力讨论的情况下，把一堆在专业实验室里经常爆炸的挥发性化学品交给一个化学专业的学生吗？也许不会。（译者注：请忽视那些对学生说王水没有毒性的，没有职业素养的老师。）然而，这正是我们的课程所做的。我们交给学生一系列的工具，专业人士经常用这些工具射击自己的脚，而我们并没有实质性地讨论我们可以采取的预防措施，以避免潜在的危及生命的错误。

也许有人会说，Strcpy 的危险性和化学实验室的危险性不一样，这里没有学生死在电脑前的危险，（好吧，我们希望如此）。然而，我认为，我们要处理的危险规模要大得多。一行代码可以轻易地影响数百万（或数十亿）人，我们的代码的影响可能比我们意识到的要大得多，即使我们不是在为汽车（我们用它杀过人）或医疗设备（我们也用它杀过人）开发软件。看起来，文件共享服务器中最坏的情况下的 bug 只是会阻止用户共享文件，但这样的一个 bug 导致过英国国家医疗服务的重大中断。非关键性的紧急事件不得不被拒绝。看起来，网络应用库中最坏的情况下的 bug 只是会让一些网站瘫痪，但这样一个 bug 却导致几乎每个有信用记录的美国成年人的极度敏感数据被泄露。

预防措施和安全措施确实存在，但人们并没有使用它们。部分原因可能是由于工具不够好或不够容易使用。部分原因可能是由于还没有足够的时间看到大规模的采用。但我认为部分原因也可能是由于缺乏围绕这些问题的教育和意识。我们可以教 C 和 C++，并希望学生们能够养成良好的习惯，学会如何在工作中使用静态分析器、Sanitizer、fuzzers 和更安全的语言，但这样一来，作为教育者的我们岂不是辜负了他们？看到软件工程师一直在犯很基本的错误，而且影响至关重要，看来是出了问题，我们应该努力做得更好。

（译者注：读到这里，做为一个软件专业的本科生，我是非常感动的。作者认为软件工程师普遍缺乏软件安全和相关工具的知识，这是一种教育者的辜负。这样的教育者才能推动科学和工业界的持续发展吧。）

## 畅想安全教育

所以，接下来我们聊聊安全。我们应该怎么做呢？

### 是否需要一门安全课程？

在策划这门课的时候，我们找不到其他的编程安全课。是因为还没有人想到要做，还是因为在讲授安全知识的同时，结合更核心的材料来讲授安全知识更好？（译者注：据我所知，一门偏理论的课程是 CMU 的 Bug Catch。这件事也反映出 CS 教育很多时候并不站在软件工程师的角度看问题，其实很多理论课是可以介绍更多编程应用的。）

特别地， "安全"的概念如此广泛，在其他课程中涵盖最佳实践和有用的技巧/工具似乎确实有帮助。然而，有两个原因让我们觉得教授完全集中在安全方面的课程是有意义的。

首先，教授一门单独的安全课给我们提供了尝试教授新材料的空间，而这些新材料很难融入到现有的课程中。特别是，我们对教授 Rust 编程语言作为一种媒介来探索生命周期和所有权的想法很感兴趣。考虑到 C 和 C++ 的噩梦般的潜在影响，将来在核心课程中教授 Rust 可能是个好主意，但鉴于 Rust 是一门新的语言，而且我们也没有什么教学经验，这是个太大的变化。

其次，虽然编写安全、正确的代码往往需要避免无数不相关的陷阱，但在安全方面确实存在一些共同的主题。例如，Rust 的所有权模型是为了确保内存安全而设计的，但 Rust 的设计者发现它也有助于促进线程安全。

## 这与信安课程有什么不同呢？

（译者注：上文中的安全课程指的是 safety 课程，编程中的安全问题。下面以现在 CS 中已经存在的 security 课程作对比，我暂且将后者翻译为信安课程。）

由于安全与信安密切相关，安全课程会与已有的信安课程有很大的重叠。特别是斯坦福大学有 155，这是一门优秀的信安课，本科生都能上，它已经很好地涵盖了内存安全和网络攻击等主题。为什么我们要单独教一些东西呢？

信安课通常侧重于在有漏洞的 C/C++ 软件的背景下教授进攻技术和防御技术，而我们认为从首先关注正确构建系统的角度进行教学可能是有益的。155 经常引导学生经历过去三十年来的猫和老鼠的游戏：攻击者是如何黑进东西的，我们又该如何堵塞他们使用的漏洞？相比之下，我们感兴趣的是探索是否有一种方法可以改变学生对待系统编程的方式，让他们在一开始就少犯错误，少制造漏洞。在 155 的第一个作业中，学生们自己看到了缓冲区溢出或双重释放是如何导致远程代码执行的，但他们不一定会对如何编写没有缓冲区溢出和双重释放的代码形成理解，当然他们也没有得到任何这方面的练习。我们能不能灌输更好的习惯，更强的危险意识，更好的使用工具，让学生一开始就写出更好的代码？

（译者注：作者在这里有一副配图，110L 这门课和 110（系统）、115（信安）两门课都有交集。）

### 我们该如何教授安全编程？

安全编程教学是很难的，有很多不同的陷阱需要注意。我们如何设计一门课，而不仅仅是一个避免错误的清单？

在我们的课上，我们想使用 Rust 编程语言来探索安全问题，Rust 编程语言是一种相对较新的系统编程语言，已经得到了广泛的应用。我们想这样做有几个具体原因。

- Rust 默认要求许多最佳实践，并防止 C 和 C++ 所允许的常见错误。通常情况下，只有一种方法可以做事情，而这种方法就是正确的方法。C++ 可以做很多和 Rust 一样的事情，但即使是它的安全特性，也到处都是不安全的行为，让人心烦意乱，教人摸不着头脑（比如 Rust 的 Option 和 C++ 的std::option 在概念上做的是一样的事情，但后者有三种方法来提取内值，其中有两种是不安全的）。
- Rust 的编译器错误比其他语言的错误更有教育意义。Rust 的核心团队花了很多时间让编译器信息变得翔实易读，甚至在出现错误时提供有用的修复建议。在某些情况下，用 Rust 编程有点像与编译器对话，编译器会教你为什么你做的事情不安全。
- 从 Rust 编程中学到的经验也适用于 C 和 C++ 的编程。在很多方面，Rust 是对 C/C++ 几十年来常见错误的回应，在教授为什么语言是这样设计的时候，我们可以讨论很多 C/C++ 代码微妙的破绽案例，并研究如何做得更好。在整个季度中，我们班有几个同学提到，在做 110 的作业时，他们感觉自己的脑子里好像有一个小小的 Rust 编译器在强调自己 C++ 代码的所有权错误。
- Rust 是一门新兴的语言，发展势头良好，确实有取代 C 和 C++ 代码的潜力。我认为它对学生的未来很有价值。

除了用 Rust 教授编程外，我们还想一定要讲讲如何将 Rust 课程应用到 C++ 中，以及如何使用工具来提高 C++ 代码的质量。在过去的 20 年里，C++ 增加了许多有用的安全特性，以帮助预防常见的问题。另外，许多静态和动态分析工具也被开发出来了，比如 linters、sanitizer 和 fuzzers，这些工具有助于识别程序中的 bug，我们希望向学生展示如何将这些工具融入到工作流程中，在开发的早期发现错误。

我不会宣称我们想出了教安全的最佳方法，但正如我后面会讨论的那样，这种方法最终效果不错。我很乐意听到关于我们可能采取的方法的任何其他想法!

## 这门课的总结

我们将 110L 作为 110 的选修补充课程，共两个单元，110 是我们的第二门核心系统课，内容包括文件系统、多处理、多线程和网络。(本科生平均课程量为15个单元。两单元的课程预计需要6小时/周的时间）。)

虽然把它作为一门独立的课可能会更好，但我们把它注册为一门补充课有两个原因。

- 它让我们更容易尝试将安全和信安的讨论与核心课程结合，如前所述。
- 一到两个单元的补充课更容易被批准，并允许在本季度有更多的即兴创作。

这给我们的课带来了一些额外的限制，因为我们需要确保材料与目前正在上 110 的学生相关。在开始的时候，平衡相互冲突的利益是很困难的，因为有很多 110 的补充材料是非常有趣的，但与安全无关，而且我们也很难安排课程，使学生在我们谈论它之前已经覆盖了 110 的所有先决材料。

### 讲座

讲课时间为 50 分钟，每周两次通过 Zoom 授课。在 50 分钟内讲完我们的材料是相当有挑战性的，今后我们可能会考虑将这门课变成三个单元的课，这样讲课就不会感觉那么匆忙。此外，通过 Zoom 进行教学一开始非常困难，我觉得我只是在对着一个没有生命的摄像机说话，很难让人感觉到我的参与，而且我很难掌握节奏和衡量学生的理解，因为我无法真正看到学生的脸。不过，随着本季度的进行，我们的表现越来越好。

你可以在这里在线找到所有的演讲材料。以下是我们所涉及的内容的概括。

- 安全
    - 内存安全
    - 异常处理
    - 多进程陷阱
    - 线程安全
- 工程
    - 网络和系统设计
    - 非阻塞 IO
    - C+

### 内存安全

Rust 依靠所有权模型来防止内存错误，如内存泄漏、双倍释放、使用后释放、迭代器无效等。学习如何在 Rust 的模型中进行操作，对于新手程序员来说可能是一个挑战，但 Rust 只是强制执行优秀的 C/C++ 程序员已经使用的习惯来编写更安全的代码。

### 异常处理的替代方法

同学们对异常已经很熟悉了，所以我们谈到了为什么异常有时会有不足之处，我们讨论了通过返回值处理异常的利弊，以及 Rust 如何通过 Option 和 Result 来处理。

### 多进程安全

110 花了几周时间介绍了 fork、管道和信号。我们花了一个半小时的时间总结了直接使用这些主题的几个常见问题，并认为应该尽可能地使用更高级别的抽象。如果学生们真的需要直接使用这些主题，我们希望他们能够知道要注意什么。

我们花了一节课的时间做了一个案例分析，介绍了 Google Chrome 浏览器如何使用多进程来促进标签页之间的隔离，即使攻击者发现了 Chrome 沙盒中的漏洞。学生们表示，这是他们最喜欢的讲座之一，因为他们看到了我们关于虚拟化和沙盒的讨论是如何在实践中发挥作用的。

### 多线程安全

我认为在多线程方面，Rust 的优势表现得最为明显。Rust 的所有权模型，禁止在一个可突变的引用存在时，对一个数据有多个引用，这已经有助于防止很多类的多线程错误。此外，Rust 的类型系统还使用了名为 Sync 和 Send 的 Marker Traits 来表示类是否可以在线程之间传递并被多个线程并发访问。使用这个类型系统，编译器会理解由 mutex 保护的数据是安全的，可以并发访问，而普通的缓冲区则不安全，它不会让你写出有数据竞争的代码。

### 网络和系统设计

我们从系统设计的角度简单地看了一下安全问题：如何保证重要系统的运行，防止攻击者破坏数据？我们讲了负载均衡（有负载均衡器、DNS 和 IP anycast）和容错，后来还让学生实现了一个负载均衡器。我们还有一个信息安全讲座，强调了确保 least resistance 路径安全的重要性（讨论Elasticsearch 等数据库太容易不安全了），以及确保依赖关系保持最新的重要性。

### 非阻塞式I/O

我们花了一周的时间专注于非阻塞 I/O 和使用 async/await 编程。这与安全无关，但对这门课的软件工程方面有帮助；在最后的项目中，我们要求学生比较和对比使用多线程的复用和使用非阻塞 I/O 的性能。虽然感觉上这是一个轻微的转移，但我认为这是一个非常有用的话题，因为 async/await 使非阻塞 I/O 的工程学变得足够简单，使学生能够在 network-bound 的应用程序中实际使用。

### C++中的安全问题

我们简单地看了一下，如何将课上的材料应用到 C++ 中，用 C++11、17 和20 语言特性。回想起来，我希望我们能花更多的时间来讨论如何写好 C++ 代码，以及如何使用工具来捕捉常见的错误。正如我们向学生们解释的那样，Rust 是一门伟大的语言，也是学习更好的编码实践的好方法，但由于Rust 相对较新，大多数系统代码库仍在使用 C 或 C++，因此了解如何在这些语言中有效地工作非常重要。虽然 Rust 在概念上能很好地映射到较新的C++ 语言特性，但 C++ 的类似语言设计得很差（在我看来），有很多方法会不小心搞砸（例如，std::option 在你使用 .value() 检索内值时，会做nullopt 检查，但当你使用 * 或 -> 运算符来做时，就不会了）。我们匆匆忙忙地完成了这些细节，如果能让学生得到实际使用这些功能的练习会更好。此外，C++ 生态系统有这么多有用的工具来捕捉错误或坏习惯（因为编译器默认情况下不会做太多），我们应该分配更多的时间来向学生展示如何使用这些工具。

### 作业

这门课有两种作业：每周的练习和项目，前者应该是对我们每周在课堂上讨论的材料进行轻量级的强化，后者则是更实质性的，可以让学生练习构建更复杂的软件。我们也给学生提供了一个选择，用一篇关于他们感兴趣的东西的博客文章来代替一周的练习，我们也允许学生用一个与他们的背景或兴趣更相关的项目来代替一个项目（例如，有计算机图形学经验的人可能会对用 Rust 实现一个并行的光线追踪器更感兴趣）。遗憾的是，没有人接受我们的这些提议，但我们很喜欢有这样的系统，这也是我将来想再做的事情。

（译者注：没有人接受提议哈哈，在我看这门课的录像的时候也可以感受到，老师真的在这门课上给出了很高的自由度。这是我喜欢的风格，对于不了解相关领域的学生来说，可以按照老师安排的作业进行练习，而有自己想法的同学也有足够的自由做自己喜欢的项目。）

我们鼓励学生们合作完成这两个项目。我觉得这对最终合作的学生来说真的很有价值，我们调查的反馈也非常积极。在更大的项目中涉及到更多的设计，所以这对学生能够讨论和辩论想法很有帮助，我认为他们从彼此的工作流程中学习到了很多东西，并学习如何使用漂亮的 Rust 语法技巧。

你可以在课程网站上找到所有的作业。

作业太多，无法在此简明扼要地总结，但为了举例说明，我最喜欢的作业是最后一个项目，它让学生实现了一个名为 balancebeam 的 HTTP 负载均衡器。除了在上游服务器之间分配请求，学生的负载均衡器还需要通过被动和主动的健康检查来支持故障转移，以及基本的速率限制。这个作业的主要重点是练习在高性能网络应用中编写安全的多线程代码。作为次要的重点，我们希望学生能够得到评估和做出影响代码简单性和性能的软件设计决策的练习。为此，我们没有告诉学生如何实现任何需求（尽管我们确实给了他们一些想法来开始）。另外，我们还实现了一个名为 balancebench 的自动基准测试工具，它可以自动对每个 git 提交进行基准测试，这样学生就可以看到设计决策是如何影响性能的。线程池是多线程好还是少线程好？非阻塞 I/O 究竟如何影响性能特性？哪些同步基元对降低延迟最有帮助？学生们能够在整个提交历史中看到基准测试结果，排行榜也让学生们以友好的方式相互竞争。

这个作业很好地利用了本季度的几乎所有材料，并让学生挑战编写安全的 Rust 代码来构建一个高性能的应用程序。我认为这个任务的开放性足以让学生能够掌握自主权并做出自己的决定，但又不至于让他们感到困惑，不知道从哪里开始或如何完成任何事情。作业范围具有足够的挑战性，让学生真正思考如何管理对共享数据结构的访问，但又足够短，不至于让人不知所措。关于 balancebench，还有一些粗糙的边缘需要熨平（最值得注意的是，由于它是在 Digitalocean 动态运转起来的实例上运行的，实例之间的网络性能在一天中都会有变化，所以基准结果并不是最一致的），但我们都在它上面收获了很多快乐。如果大家有兴趣的话，我很想写一篇更详细的博文来介绍这个作业。

## 调查结果

总的来说，我对这门课的情况非常满意。学生们表示从这门课中学到了很多东西，在官方课程调查中，对 "你学到了多少 "和 "你接受的指导效果如何 "的回答是4.8/5，并强烈推荐给其他将来考虑这门课的学生。

根据调查结果，我们的主要弱点是试图在一个小班级中装入太多东西。少数学生指出，对于2个单元的课程来说，讲座有时进行得太快，作业有时过于雄心勃勃。这些都是完全公平的抱怨。

除了官方课程调查上的问题（这些问题太过笼统，没有什么帮助），我们还做了自己的季度末调查。我摘录了一些我认为最有趣/最有见地的回答。这里有一些明显的抽样偏差，因为不喜欢这门课的学生不太可能在选修课上留下任何反馈，但我们在整个季度都非常努力地调查学生，我们这是最好的代表。

在整个季度中，什么材料最让你印象深刻？

- 我想到的最普遍的话题是数据所有权、枚举、选项/结果和同步。在CS110L 中，我最自豪的时刻是完成了 DEET 调试器。那个项目把课上很多最相关的主题都总结到了那个点上，也标志着我觉得自己真正开始掌握 Rust 了。至于最有趣的，我想说是代理项目。到了那个时候，我们已经掌握了 Rust，并且能够实现一些很酷的功能，同时把一个负载平衡器放在一起。
- 哇--学习Rust真是太神奇了。Google Chrome 的案例研究非常棒--在 waitpid 中谈论不安全的代码例子很酷，async 编程很狂野......想到这门课，我的脑海里浮现出很多东西
- 由于我已经有了一些 Rust 的背景，我认为当我们进入本季度后半段时，它才真正开始受到冲击。关于 Google Chrome 和 Mozilla Firefox的讨论是一个亮点--超级有趣，它为Rust的重要性提供了很好的现实世界动机。网络部分也教得很好（漂亮的图表！），而且很有趣。另外，我很喜欢 Sergio 的演讲！如果能使用一些Rust的技术，那就更好了。
- 我喜欢关于更广泛的安全理念的演讲。比如我们谈到混沌工程，以及Netflix是如何使用混沌工程来使他们的系统更加强大。我也很喜欢在课堂的最开始，我们谈到了缓冲区溢出

（译者注：突然想到所以进行一下补充，斯坦福介绍 Rust 编程的还有一门课，CS 242 编程语言。那门课的重点是介绍编程语言，老师就是最开始致谢中提到的 Will Crichton，他还写了一篇论文 From Theory to Systems: A Grounded Approach to Programming Language Education [https://arxiv.org/abs/1904.06750](https://arxiv.org/abs/1904.06750)。可见斯坦福的老师真的厨力满满。下次我们可以再来聊那门课。）

你最喜欢的两三个作业是什么，为什么？

- 正如之前的回答中提到的，我非常喜欢这两个项目。不仅感觉我能够从项目中真正学到很多东西，而且伙伴方面的帮助也让工作经历变得更加愉快。此外，与我在斯坦福大学的其他CS任务相比，它们都非常独特（除了110代理任务，这是意料之中的）。我们都花了大量的时间来使用调试器，但现在我们都可以说，我们也做了一个调试器! 虽然超级简单，但我真的很欣赏农场遇到多线程的任务[第6周练习]，因为它在很大程度上显示了我们从本季度开始时花了几个小时来实现刽子手（lol）所取得的进展。
- 我最喜欢的是Proj 1，因为我从来没有想过真的要写一个调试器，看到它们是如何工作的是很酷的，还有通道作业，只是因为通道真的很酷，而且非常优雅地解决了问题。
- 我喜欢channel mapreduce这个任务，因为它并不难对付，但它足够复杂，让你真正思考你的设计。我也很喜欢两个更大的项目，因为两个项目的结果都很酷。
- 肯定是这两个项目! 只是好在能多接触一些比较复杂的项目。这两个项目的脚手架真的很好，项目二的基准工具也很棒。他们感觉比CS 110的一些作业更精致，这对于一个第一次学习课程的人来说是非常重要的。我也很喜欢Farm遇见多线程的那个，因为我记得做那个CS 110的作业，在Rust中使用多线程就容易多了，哈哈。

对于这门课，你有什么建议？再教一次？整合其他材料？安全主题觉得值不值得，你觉得效果好不好，还是把这门课做成 Rust 语言课而不是一般的安全课会更好？

- 10000000000% 是再教一次。安全主题完美契合，因为它让我体会到了Rust。这个季度的弧线对我来说是： 我讨厌Rust ->我有点明白为什么你要用Rust，但我讨厌Rust ->Rust让这种并发的东西变得很容易... ->我想继续学习Rust，并利用我学到的知识让我的C++变得更好。如果这只是一个Rust语言课，我就不会有这个弧度了--我可能会放弃，因为我看不出目的。既然你们都说它有更好的安全功能，我就想看看那是什么，于是我决定留下来，把难的部分熬过去。以安全为框架是一个很好的方式来保持人们的兴趣/让他们去尝试新的东西!
- 这是一堂很棒的课，所以如果再教一次就好了。我确实认为安全主题有价值，但我可能更喜欢失去一些内容，以获得更多的Rust内容。
- 我认为我希望看到更多关于一般安全的内容，以及它如何与这些主题相关。Rust是探索这些概念的绝佳工具，但我认为我更喜欢其中的安全部分。
- 我认为这门课很棒。我不愿意提出太多的改变，因为我不想让它离它的定位太远，而这个定位（我觉得）就是把相对较新的CS学生介绍给Rust。我认为让它成为一门安全课而不是Rust课是完全合理的--对于激励来说要好得多。不过我绝对认为我们还需要更多关于这些主题的高层次课程。例如，我希望Rust的CS 140E是一个持续的东西。我想我们也许也应该有一门课，从CS 242 / Sergio的讲座开始--假设有PL、编译器和系统的先决条件，然后从那里深入到语言、库和系统设计。

（译者注：我很喜欢这些反馈！在看这门课的录像的时候，我也有很多类似的感受。同样期待类似这种课的改革发生在更高级的课程上，毛多毛多 Please！）

## 经验教训

如前所述，这节课在很多方面都是一次实验。以下是我们曾想寻找答案的一些问题。

### 在CS课程中是否应该有安全课的位置？

简短的回答。我还不是百分百确定！

长话短说。我认为这门课的效果很好，让学生们对他们所写的代码进行了更仔细的思考和批判性的思考。我认为有些材料可以在CS核心课中使用，而不是在单独的课中（例如，我们可以在CS 110中谈论通道，并教学生如何使用santizers 检查潜在的竞争条件），但有一个单独的课对于实验更大的变化非常有帮助，例如教授Rust。随着核心课程的改进，对安全课的需求可能会减少，但我认为总会有一门课的位置，这门课研究的是系统中经常出现的问题，以及我们如何改进实践以建立更好的系统。

### 对于学生来说，在短时间内学习Rust是什么感觉？

就像人们通常所说的那样，Rust的学习曲线很陡峭，要想在短时间内对它有所收获真的很难。这一点在2019年的Rust语言调查中有所体现，在我们每周的调查回复中，前几周学生的挫败感也有所体现。尽管如此，即使只有几周的时间，也可以让学生达到构建他们引以为傲的软件的程度。

我们做了几件事，我认为对这一点有帮助。

- 尽可能地将Rust精简为几个关键的功能，并且只关注这些功能。Rust的语言面非常大，如果我们想把Rust教透，就没有时间教其他东西了。我们明确告诉学生 "这不是一门Rust课！"以帮助设定期望值。
- 用简单的解释和例子来激励为什么Rust是这样的。学生经常会因为语言的困难而感到沮丧，因为在其他语言中看似简单的事情，在Rust中有时是不允许的。承认这种挫折感并解释为什么rustc会抱怨，有助于学生更快上手，也有助于他们在用其他语言编程时识别潜在的问题模式。
- 尽可能避免提及易混淆的术语。Rust有很多官方术语，有时来自PL理论或函数式编程，我们的目标受众都没有接触过这些术语。

### 我们应该尝试将Rust纳入斯坦福大学的核心课程吗？

可能不是，现在还不是。

斯坦福大学有两门核心系统课程。CS 107 (介绍C编程) 和CS 110 (用C++教授多处理、多线程和网络)。Rust 诡异地位于这两门课之间。所有权模型肯定更适合CS 107教材，但Rust的吸引力很大一部分在于它在使用多线程和/或网络的程序中的有效性，在不了解基于并发的动机的情况下，花这么多精力去对抗 borrow checker 可能会令人沮丧。

虽然我认为Rust在CS 107中的动机会很差，但我认为它在CS 110中的适用性格外差。CS 110不仅仅是关于我们如何做事情，也是关于为什么--为什么事情会被设计成这样，如果我们得到某些bug或性能特性，那是为什么？我认为Rust中的原因体现得不够。它向你展示了一种哲学，并说，"遵循这种哲学，它就能保证你的安全"。因此，思想上没有偏差的空间。你无法体验为什么不，因为编译器不会让你体验。虽然它会试图通过错误信息来解释为什么不，但眼见为实。看着一个程序崩溃烧毁和得到一两行编译器错误解释你是如何偏离 Rust 模型是不一样的。在Rust中讲授多处理也是很困难的，因为标准库没有办法调用fork，信号处理支持也同样不存在。Rust有很好的抽象，在普通情况下是可以用的，但一个好的系统程序员应该知道它们在引擎盖下是如何工作的，如果被抽象的东西贴满了，学生很难真正建立起对机器中发生的事情的直觉。

我也认为，如果没有先体验过C和C++，学生很难体会到Rust的魅力。有两个学生说得很好。

- 我不太同意[Rust会是更好的第一门语言]。用C++编码的110让我更能理解Rust所保护的错误。如果我只是信任Rust，我将拥有无错误的程序，但我不会理解它在保护我什么。例如，在Assign5 for 110(aggregator)中，一个常见的错误是将会超出范围的数据引用传递给线程(由于寿命的原因，rust永远不会允许这种错误)。当我遇到这个错误时，事情很快就有了眉目。我想起我自己应该在C++中考虑lifetimes的问题，就像Rust为我做的那样。在整个课堂上看到这两种语言在一起，只是让我更深刻地理解了错误，如果110只用更安全的语言来教，我想我会失去这个机会。
- 我不认为rust是一门好的教学语言，原因几乎和我不认为python是一门好的教学语言相反--你需要用一门能把你搞死的语言来学习编程，那样你才能学到更好的习惯。Rust是不错的，一旦你对C这样的语言有了脚步，你就会痛定思痛地意识到它可能造成的伤害。我和我的搭档在上一次作业的时候就在讨论这个问题--rust编译器几乎让作业的某些部分变得太容易了。也许从学习的角度来看，这是好的--你不希望学生为愚蠢的内存bug花费数小时，但我错误地认为，让他们谨慎与让他们依赖一个强大的编译器。

尤其是今天的系统代码仍然是由C和C++主导的，我认为对学生来说，能够体会到Rust的保证，同时还能意识到编译器在为你做什么，保护你免受其害，这是非常宝贵的。

### 这应该是一门独立的课，还是继续作为CS 110的附加课？

我不确定这个问题。我正在考虑再次提供这门课，我在犹豫是以同样的形式提供，还是把它作为一个独立的课。

一方面，把它注册成一门独立的课，可以让我们专注于安全主题，而不需要跟着CS 110的教学大纲走。这种灵活性对于能够花更多的时间在C++安全和工具上是非常有用的，因为我们可以把多线程的讨论移到更早的时候进行，在课程结束时留下更多的时间，而不用担心跑在CS 110前面。此外，我认为把更多的单元奉献给这门课是件好事，因为它比一般的两个单元的课程花费的时间更多。

然而，我认为把它变成一个小型的、两个单元的课程，让更多的人能够接触到它，而且我认为这两门课最终很好地互补了（CS 110L让学生更容易实现和调试CS 110的作业，而CS 110让学生更好地了解了我们在CS 110L中讨论的问题）。

如果你有这方面的想法，请告诉我。

## 一般的教学经验

这个季度我们尝试了一些我非常喜欢的事情。

- 由于COVID -19的原因，这门课是在线教学的。我们试图找到方法来创建社区，这通常是在人们等着开始上课或者在办公时间做作业时发展起来的。我们有一个课程Slack，用于问答、公告和与课程材料相关的随机新闻文章，我认为这非常有效，部分原因是我们的班级规模小。在这个Slack中，我们创建了一个#反思频道，并提示学生每周发布他们觉得有趣的事情和/或正在努力的事情。这帮助学生们看到他们并不是一个人发现Rust的某些方面令人困惑，这也帮助我们确定了学生们正在努力学习的材料。我们还主持了 "非办公时间"，这是一个休闲的Zoom电话，专门讨论课程材料以外的任何事情。我很喜欢通过这种方式更好地了解学生，而在我们的调查中，学生们也表示他们也很喜欢互相了解。
- 如前所述，我们鼓励学生用一篇博客文章或一个替代想法的项目来代替每周的练习。尽管最终没有人这样做，但我们确实与一些学生讨论了他们的想法，我认为学生有这样的选择是很好的。
- 我们每周都有调查，并不断征求反馈意见。如果执行得不好，这可能会产生很多噪音，但我认为这对我们在本季度改进课堂很有帮助，而且对获得高质量的意见也很有帮助（而不是在本季度结束时进行民意调查获得反馈，那时学生们已经忘记了所有喜欢/不喜欢的事情的具体细节，只想继续前进）。

我也认为在这门课上我学到了很多关于作业设计的知识。学习如何在课堂上教授东西和让学生在作业中学习之间取得平衡是很有趣的。你不可能把所有的东西都在讲课中教给学生，学生自己综合材料很重要。如果你能在作业中引导他们自己去发现东西，会更有收获和效果--他们会比记住讲课的片段更能记住这个历程。但当然，这样做会增加作业的难度和时间，如果学生偏离了你心目中的道路，就会导致不好的结果。学习如何在作业中平衡脚手架也很有趣。包括脚手架（如骨架函数和单元测试）会让作业运行得更顺畅，但也减少了学生创造的空间。在整堂课中，我们的作业是混合的。有些学生说他们很欣赏棚架式的练习，几乎每个人都表示在这些作业上花费的时间较少，但其他学生说他们更喜欢开放式的练习。

## 结束

安全是系统编程中的一个大问题，我们认为开设一门课教学生了解常见的陷阱，如何避免这些陷阱，以及现代工具可能存在的不足之处是有意义的。

你可以在这里的网站上找到完整的课程材料。

把这门课放在一起真的很困难。我们从头开始设计这门课（包括讲座和作业），而且没有任何类似的课程可以借鉴。我们需要在短时间内适应在线形式，而且由于COVID-19和全国性的抗议活动，学生在整个季度都面临着不稳定。此外，直到开课前三周，我实际上还没有写过任何Rust代码。

然而，这是一次非常有意义的经历，我学到了很多东西。我们希望能再次修订和教授这门课。

如果你对这门课有任何想法或反馈，请联系我。我只是一个低级的研究生，没有什么实质性的计算机系统建设经验，我认为这是一个具有挑战性的课题，如果你有任何意见，请发邮件给我，我很乐意与你讨论!
